<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyharikFW - –ü–∞–Ω–µ–ª—å –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
    <link rel="stylesheet" href="style.css">
    <script src=".js"></script>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="side-decoration left"></div>
    <div class="side-decoration right"></div>
    <div class="corner-decoration top-left"></div>
    <div class="corner-decoration bottom-right"></div>

    <div class="container">
        <div class="header-top">
            <div class="team-name">Syharik3316</div>
            <div class="user-menu" id="user-menu">
                <div class="user-info" id="user-info">
                    <span class="user-avatar">üë§</span>
                    <span class="username" id="username">admin</span>
                    <button class="logout-btn" id="logout-btn" title="–í—ã–π—Ç–∏">üö™</button>
                </div>
            </div>
        </div>
        <h1>–£–¥–æ–±–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º–æ–π SyharikFW</h1>

        <div class="status offline" id="service-status">
            –°–ï–†–í–ò–° SyharikFW –ù–ï–î–û–°–¢–£–ü–ï–ù. –°–¢–ê–¢–£–°: OFFLINE
        </div>

        <p>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è SyharikFW, –¥–ª—è –∑–∞—â–∏—Ç—ã —Å–µ—Ä–≤–µ—Ä–æ–≤ by Syharik3316</p>
        <p>–í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è</p>

        <div class="buttons">
            <button class="btn" id="add-port-btn" onclick="showPortForm()">–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Ä—Ç</button>
            <button class="btn" id="remove-port-btn" onclick="showRemovePortForm()">–£–¥–∞–ª–∏—Ç—å –ø–æ—Ä—Ç</button>
            <button class="btn" onclick="showPortList()">–°–ø–∏—Å–æ–∫ –ø–æ—Ä—Ç–æ–≤</button>
            <button class="btn" onclick="showFirewallControls()">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ firewall'–æ–º</button>
            <button class="btn" onclick="window.open('/logs.html', '_blank')">–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤</button>
            <button class="btn" onclick="window.open('/settings.html', '_blank')">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>

        <div class="services">
            <div class="service-item">
                <h3>–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ—Ä—Ç—ã</h3>
                <div class="port-list-container">
                    <button class="toggle-list-btn" id="toggle-ports-btn" style="display: none;">
                        <span id="toggle-ports-text">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Å–ø–∏—Å–æ–∫</span>
                    </button>
                    <ul class="port-list" id="open-ports"></ul>
                </div>
                <div id="forms"></div>

                <div class="stats">
                    <div class="stat-item">
                        <p>–í—Å–µ–≥–æ –ø–æ—Ä—Ç–æ–≤</p>
                        <div class="stat-value" id="total-ports">0</div>
                    </div>
                    <div class="stat-item">
                        <p>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</p>
                        <div class="stat-value" id="last-update">‚Äî</div>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>SyharikFW Management System | ¬© 2025 –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã</p>
            <p>–í–µ—Ä—Å–∏—è: 2.0 | –°–±–æ—Ä–∫–∞: #SyFW-PORTS-15-11-2025</p>
        </footer>
    </div>
    <script>
    (function() {
        const portsListElement = document.getElementById('open-ports');
        const totalPortsElement = document.getElementById('total-ports');
        const lastUpdateElement = document.getElementById('last-update');
        const formsContainer = document.getElementById('forms');
        const statusElement = document.getElementById('service-status');

        const apiBase = '';
        let wellKnownPorts = {};
        let lastUpdateTs = null;
        let lastUpdateTimerId = null;

        setOffline();
        
        fetch(`${apiBase}/api/user`).then(r => r.json()).then(data => {
            if (data.username) {
                document.getElementById('username').textContent = data.username;
            }
        }).catch(() => {});
        
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                await fetch(`${apiBase}/api/auth/logout`, { method: 'POST' });
                window.location.href = '/login.html';
            } catch (e) {
                window.location.href = '/login.html';
            }
        });
        
        setInterval(() => refreshStatus(), 2000);
        Promise.all([
            fetch(`${apiBase}/api/well-known`).then(r => r.json()),
            fetch(`${apiBase}/api/state`).then(r => r.json())
        ]).then(([dict, state]) => {
            wellKnownPorts = dict || {};
            renderPorts(state.ports || []);
            setLastUpdate(state.lastUpdateTs || Date.now());
            applyStatus(state.status);
        }).catch(() => {
            renderPorts([]);
            setLastUpdate(null);
        });
        
        const togglePortsBtn = document.getElementById('toggle-ports-btn');
        const portsList = document.getElementById('open-ports');
        const MAX_VISIBLE_PORTS = 10;
        let portsExpanded = false;
        
        togglePortsBtn.addEventListener('click', () => {
            portsExpanded = !portsExpanded;
            if (portsExpanded) {
                portsList.style.maxHeight = 'none';
                togglePortsBtn.querySelector('#toggle-ports-text').textContent = '–°–≤–µ—Ä–Ω—É—Ç—å —Å–ø–∏—Å–æ–∫';
            } else {
                portsList.style.maxHeight = `${MAX_VISIBLE_PORTS * 50}px`;
                togglePortsBtn.querySelector('#toggle-ports-text').textContent = '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Å–ø–∏—Å–æ–∫';
            }
        });

        function renderPorts(ports) {
            const uniqueSorted = Array.from(new Set(ports)).sort((a,b) => a - b);
            portsListElement.innerHTML = '';
            uniqueSorted.forEach(port => {
                const li = document.createElement('li');
                const left = document.createElement('span');
                left.className = 'port-status open';
                const label = document.createElement('span');
                const name = wellKnownPorts[port] ? ` (${wellKnownPorts[port]})` : '';
                label.textContent = ` ${port}${name}`;
                li.appendChild(left);
                li.appendChild(label);
                portsListElement.appendChild(li);
            });
            totalPortsElement.textContent = String(uniqueSorted.length);
            
            const toggleBtn = document.getElementById('toggle-ports-btn');
            if (uniqueSorted.length > MAX_VISIBLE_PORTS) {
                toggleBtn.style.display = 'block';
                portsListElement.style.maxHeight = `${MAX_VISIBLE_PORTS * 50}px`;
                portsListElement.style.overflowY = 'auto';
                portsExpanded = false;
                toggleBtn.querySelector('#toggle-ports-text').textContent = '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Å–ø–∏—Å–æ–∫';
            } else {
                toggleBtn.style.display = 'none';
                portsListElement.style.maxHeight = 'none';
                portsListElement.style.overflowY = 'visible';
            }
        }

        function humanizeSince(ts) {
            if (!ts) return '‚Äî';
            const seconds = Math.floor((Date.now() - ts) / 1000);
            if (seconds < 5) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
            if (seconds < 60) return `${seconds} —Å–µ–∫ –Ω–∞–∑–∞–¥`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} –º–∏–Ω –Ω–∞–∑–∞–¥`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} —á –Ω–∞–∑–∞–¥`;
            const days = Math.floor(hours / 24);
            return `${days} –¥ –Ω–∞–∑–∞–¥`;
        }

        function startLastUpdateTicker() {
            if (lastUpdateTimerId) clearInterval(lastUpdateTimerId);
            lastUpdateTimerId = setInterval(() => {
                lastUpdateElement.textContent = humanizeSince(lastUpdateTs);
            }, 1000);
        }

        function setLastUpdate(ts) {
            lastUpdateTs = ts;
            lastUpdateElement.textContent = humanizeSince(lastUpdateTs);
            startLastUpdateTicker();
        }

        function setOffline() {
            statusElement.classList.remove('online');
            statusElement.classList.add('offline');
            statusElement.textContent = '–°–ï–†–í–ò–° SyharikFW –ù–ï–î–û–°–¢–£–ü–ï–ù. –°–¢–ê–¢–£–°: OFFLINE';
        }

        function applyStatus(status) {
            const addBtn = document.getElementById('add-port-btn');
            const removeBtn = document.getElementById('remove-port-btn');
            
            if (status === 'ONLINE') {
                statusElement.classList.remove('offline');
                statusElement.classList.add('online');
                statusElement.textContent = '–°–ï–†–í–ò–° SyharikFW –ê–ö–¢–ò–í–ï–ù. –°–¢–ê–¢–£–°: ONLINE';
                if (addBtn) addBtn.disabled = true;
                if (removeBtn) removeBtn.disabled = true;
            } else {
                setOffline();
                if (addBtn) addBtn.disabled = false;
                if (removeBtn) removeBtn.disabled = false;
            }
        }

        async function refreshStatus() {
            try {
                const resp = await fetch(`${apiBase}/api/status`);
                const json = await resp.json();
                applyStatus(json.status);
            } catch (e) {
                setOffline();
            }
        }

        window.showPortForm = function showPortForm() {
            formsContainer.innerHTML = '';
            const form = document.createElement('div');
            form.className = 'port-form';
            form.innerHTML = `
                <input id="port-input" class="port-input" type="text" placeholder="–ü–æ—Ä—Ç –∏–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä: 8080 –∏–ª–∏ 1000-2000 –∏–ª–∏ 80,443,1000-2000)">
                <small style="color: #b0bec5; display: block; margin-top: 5px; text-align: left;">
                    –ü—Ä–∏–º–µ—Ä—ã: 8080 (–æ–¥–∏–Ω –ø–æ—Ä—Ç), 1000-2000 (–¥–∏–∞–ø–∞–∑–æ–Ω), 80,443,1000-2000 (–Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ä—Ç–æ–≤ –∏ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤)
                </small>
                <button class="btn" id="add-port-btn">–î–æ–±–∞–≤–∏—Ç—å</button>
            `;
            formsContainer.appendChild(form);
            const input = form.querySelector('#port-input');
            const addBtn = form.querySelector('#add-port-btn');
            addBtn.addEventListener('click', async () => {
                const value = input.value.trim();
                if (!value) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –ø–æ—Ä—Ç –∏–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω –ø–æ—Ä—Ç–æ–≤');
                    return;
                }
                try {
                    const resp = await fetch(`${apiBase}/api/ports`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ port: value })
                    });
                    if (resp.status === 409) {
                        alert('–ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω—è—Ç—å –ø–æ—Ä—Ç—ã –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã SyharikFW!');
                        return;
                    }
                    const state = await resp.json();
                    if (resp.ok) {
                        const message = state.added ? `–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ—Ä—Ç–æ–≤: ${state.added}` : '–ü–æ—Ä—Ç –¥–æ–±–∞–≤–ª–µ–Ω';
                        alert(message);
                        renderPorts(state.ports || []);
                        setLastUpdate(state.lastUpdateTs || Date.now());
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + (state.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    }
                } catch (e) {
                    alert('–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                }
            });
        };

        window.showRemovePortForm = function showRemovePortForm() {
            formsContainer.innerHTML = '';
            const form = document.createElement('div');
            form.className = 'port-form';
            form.innerHTML = `
                <input id="port-remove-input" class="port-input" type="text" placeholder="–ü–æ—Ä—Ç –∏–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä: 8080 –∏–ª–∏ 20-100 –∏–ª–∏ 80,443,20-100)">
                <small style="color: #b0bec5; display: block; margin-top: 5px; text-align: left;">
                    –ü—Ä–∏–º–µ—Ä—ã: 8080 (–æ–¥–∏–Ω –ø–æ—Ä—Ç), 20-100 (–¥–∏–∞–ø–∞–∑–æ–Ω), 80,443,20-100 (–Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ä—Ç–æ–≤ –∏ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤)
                </small>
                <button class="btn" id="remove-port-btn">–£–¥–∞–ª–∏—Ç—å</button>
            `;
            formsContainer.appendChild(form);
            const input = form.querySelector('#port-remove-input');
            const removeBtn = form.querySelector('#remove-port-btn');
            removeBtn.addEventListener('click', async () => {
                const value = input.value.trim();
                if (!value) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –ø–æ—Ä—Ç –∏–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω –ø–æ—Ä—Ç–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
                    return;
                }
                try {
                    const encodedValue = encodeURIComponent(value);
                    const resp = await fetch(`${apiBase}/api/ports/${encodedValue}`, { method: 'DELETE' });
                    if (resp.status === 409) {
                        alert('–ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω—è—Ç—å –ø–æ—Ä—Ç—ã –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã SyharikFW!');
                        return;
                    }
                    const state = await resp.json();
                    if (resp.ok) {
                        const message = state.deleted ? `–£–¥–∞–ª–µ–Ω–æ –ø–æ—Ä—Ç–æ–≤: ${state.deleted}` : '–ü–æ—Ä—Ç —É–¥–∞–ª–µ–Ω';
                        alert(message);
                        renderPorts(state.ports || []);
                        setLastUpdate(state.lastUpdateTs || Date.now());
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + (state.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    }
                } catch (e) {
                    alert('–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                }
            });
        };

        window.showPortList = function showPortList() {
            formsContainer.innerHTML = '';
            const hint = document.createElement('div');
            hint.className = 'port-form';
            hint.innerHTML = '<p>–û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ—Ä—Ç–æ–≤...</p>';
            formsContainer.appendChild(hint);
            fetch(`${apiBase}/api/state`).then(r => r.json()).then(state => {
                renderPorts(state.ports || []);
                setLastUpdate(state.lastUpdateTs || Date.now());
                applyStatus(state.status);
                hint.innerHTML = '<p>–°–ø–∏—Å–æ–∫ –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.</p>';
                setTimeout(() => { formsContainer.innerHTML = ''; }, 1500);
            }).catch(() => {
                hint.innerHTML = '<p>–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</p>';
            });
        };

        window.showFirewallControls = function showFirewallControls() {
            formsContainer.innerHTML = '';
            const form = document.createElement('div');
            form.className = 'port-form';
            form.innerHTML = `
                <input id="iface-input" class="port-input" type="text" placeholder="–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–Ω–∞–ø—Ä., eth0, lo)">
                <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
                    <button class="btn" id="start-fw-btn">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
                    <button class="btn" id="stop-fw-btn">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                </div>
            `;
            formsContainer.appendChild(form);
            const ifaceInput = form.querySelector('#iface-input');
            const startBtn = form.querySelector('#start-fw-btn');
            const stopBtn = form.querySelector('#stop-fw-btn');
            startBtn.addEventListener('click', async () => {
                const iface = ifaceInput.value.trim();
                try {
                    const resp = await fetch(`${apiBase}/api/firewall/start`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ iface: iface || undefined })
                    });
                    const json = await resp.json();
                    applyStatus(json.status);
                } catch (e) { alert('–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'); }
            });
            stopBtn.addEventListener('click', async () => {
                try {
                    const resp = await fetch(`${apiBase}/api/firewall/stop`, { method: 'POST' });
                    const json = await resp.json();
                    applyStatus(json.status);
                } catch (e) { alert('–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'); }
            });
        };
    })();
    </script>
</body>
</html>
